<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatura Oluşturucu</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .invoice-title { font-size: 24px; font-weight: bold; color: #28a745; text-align: right; }
        .invoice-details { text-align: right; }
        .company-info, .bill-to { margin-bottom: 20px; }
        .company-name, .bill-to-title, .section-title { font-weight: bold; margin-bottom: 5px; }
        .bill-to-title, .section-title { color: #28a745; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background-color: #28a745; color: white; padding: 10px; text-align: left; }
        td { padding: 10px; border: 1px solid #ddd; }
        .totals { width: 300px; margin-left: auto; }
        .totals td { padding: 5px; border: none; }
        .total-row td { font-weight: bold; }
        .thank-you { text-align: center; color: #28a745; font-weight: bold; margin-top: 20px; }
        .divider { border-top: 1px solid #ddd; margin: 20px 0; }
        .company-link { color: #28a745; text-decoration: none; }
        .company-link:hover { text-decoration: underline; }
        .form-section { margin-bottom: 20px; }
        .form-row { display: flex; align-items: center; margin-bottom: 10px; }
        .form-row label { width: 150px; margin-right: 10px; }
        .input-field { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        .input-number { width: 120px; }
        .btn { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn:hover { background-color: #218838; }
        .buttons-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

    <div id="formPage" class="container">
        <h2>Fatura Bilgilerini Düzenle</h2>

        <!-- Firma Seçimi -->
        <div class="form-section">
            <div class="section-title">Fatura Oluşturan Firma</div>
            <div class="form-row">
                <label for="issuerSelect">Kayıtlı Firmalar:</label>
                <select id="issuerSelect" class="input-field"><option value="">Yeni Firma Ekle</option></select>
            </div>
            <button type="button" id="saveIssuerBtn" class="btn" style="display:none;">Kişiyi Kaydet</button>
        </div>

        <!-- Şirket Bilgileri -->
        <div class="form-section">
            <div class="section-title">Şirket Bilgileri</div>
            <div class="form-row"><label>Şirket Adı:</label><input id="companyName" class="input-field"></div>
            <div class="form-row"><label>Adres 1:</label><input id="companyAddress1" class="input-field"></div>
            <div class="form-row"><label>Adres 2:</label><input id="companyAddress2" class="input-field"></div>
            <div class="form-section"><label>Adres 3:</label><input id="companyAddress3" class="input-field"></div>
            <div class="form-row"><label>Vergi No:</label><input id="taxNumber" class="input-field"></div>
            <div class="form-row"><label>Telefon:</label><input id="phoneNumber" class="input-field"></div>
            <div class="form-row"><label>E-posta:</label><input id="email" class="input-field"></div>
            <div class="form-row"><label>Web Sitesi:</label><input id="website" class="input-field"></div>
        </div>

        <!-- Fatura Detayı, Müşteri, Ürün, Ödeme vs. alanları burada aynı yapıda devam edecek -->

        <div class="buttons-container no-print">
            <button class="btn" onclick="generatePreview()">Fatura Önizleme</button>
        </div>
    </div>

    <!-- Önizleme -->
    <div id="previewPage" class="container" style="display:none;">
        <!-- Burada preview HTML içeriği tam olarak yer alır -->
    </div>

    <script>
        // front-end: issuer CRUD
        async function loadIssuers() {
            try { const res = await fetch('/issuers.json'); if (!res.ok) throw ''; return await res.json(); }
            catch { return []; }
        }
        async function saveIssuerToServer(o) {
            await fetch('/issuers', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(o) });
        }
        async function populateIssuerSelect() {
            const arr = await loadIssuers();
            const sel = document.getElementById('issuerSelect');
            arr.forEach((o,i)=>{ let opt=document.createElement('option'); opt.value=i; opt.textContent=o.companyName; sel.append(opt); });
        }
        function fillCompanyFields(o) {
            ['companyName','companyAddress1','companyAddress2','companyAddress3','taxNumber','phoneNumber','email','website']
            .forEach(id=>document.getElementById(id).value=o[id]||'');
        }
        function clearCompanyFields() {
            ['companyName','companyAddress1','companyAddress2','companyAddress3','taxNumber','phoneNumber','email','website']
            .forEach(id=>document.getElementById(id).value='');
        }
        document.addEventListener('DOMContentLoaded', async ()=>{
            await populateIssuerSelect();
            const sel=document.getElementById('issuerSelect'), btn=document.getElementById('saveIssuerBtn');
            sel.addEventListener('change', ()=>{
                if (sel.value==='') { clearCompanyFields(); btn.style.display='inline-block'; }
                else { loadIssuers().then(a=>{ fillCompanyFields(a[sel.value]); btn.style.display='none'; }); }
            });
            btn.addEventListener('click', async ()=>{
                const o={};
                ['companyName','companyAddress1','companyAddress2','companyAddress3','taxNumber','phoneNumber','email','website']
                .forEach(id=>o[id]=document.getElementById(id).value);
                await saveIssuerToServer(o);
                window.location.reload();
            });
        });
        // generatePreview() ve backToForm() fonksiyonları burada
    </script>
</body>
</html>
